<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>Admin Panel - Mandor Sawit</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
/* RESET & BASE */
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:'Inter','Segoe UI',system-ui,-apple-system,sans-serif;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);
  background-attachment:fixed;
  min-height:100vh;
  padding:20px 0 40px;
  margin:0;
  color:#1e293b
}

/* ANIMATIONS */
@keyframes slideDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes scaleIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}

/* HEADER */
h2{
  text-align:center;
  margin:0 0 24px;
  font-size:2.2rem;
  font-weight:800;
  color:#fff;
  text-shadow:0 4px 12px rgba(0,0,0,.3);
  animation:slideDown .6s ease-out
}
h3{
  margin:0 0 16px;
  font-size:1.2rem;
  font-weight:700;
  color:#1e293b;
  display:flex;
  align-items:center;
  gap:8px;
  padding-bottom:8px;
  border-bottom:2px solid #e2e8f0
}

/* CONTAINER */
.container{
  max-width:550px;
  margin:0 auto;
  padding:0 16px
}

/* CARD */
.card{
  background:rgba(255,255,255,.95);
  backdrop-filter:blur(10px);
  padding:24px;
  border-radius:20px;
  margin-bottom:20px;
  box-shadow:0 20px 60px rgba(0,0,0,.15),0 0 0 1px rgba(255,255,255,.5) inset;
  border:1px solid rgba(255,255,255,.3);
  transition:all .3s cubic-bezier(.4,0,.2,1);
  animation:scaleIn .5s ease-out backwards;
  animation-delay:calc(var(--card-index,0) * .1s)
}
.card:hover{
  transform:translateY(-4px);
  box-shadow:0 25px 70px rgba(0,0,0,.2),0 0 0 1px rgba(255,255,255,.6) inset
}

/* FORM ELEMENTS */
label{
  display:block;
  font-size:.9rem;
  color:#475569;
  font-weight:600;
  margin:16px 0 6px;
  letter-spacing:.3px
}
input,select{
  width:100%;
  padding:12px 16px;
  margin-top:8px;
  border-radius:12px;
  border:2px solid #e2e8f0;
  background:#fff;
  font-size:.95rem;
  transition:all .2s;
  box-shadow:0 2px 8px rgba(0,0,0,.05);
  color:#1e293b;
  font-family:inherit
}
input:focus,select:focus{
  outline:none;
  border-color:#667eea;
  box-shadow:0 0 0 4px rgba(102,126,234,.1),0 4px 16px rgba(0,0,0,.1);
  transform:translateY(-2px)
}
input::placeholder{
  color:#94a3b8
}
input[type="file"]{
  padding:10px;
  cursor:pointer;
  font-size:.85rem
}

/* BUTTONS */
button{
  width:100%;
  padding:14px 20px;
  margin-top:12px;
  border-radius:12px;
  border:none;
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:#fff;
  font-size:1rem;
  font-weight:700;
  cursor:pointer;
  transition:all .3s cubic-bezier(.4,0,.2,1);
  box-shadow:0 8px 20px rgba(102,126,234,.3);
  text-transform:uppercase;
  letter-spacing:.8px;
  position:relative;
  overflow:hidden;
  min-height:48px;
  touch-action:manipulation;
  -webkit-tap-highlight-color:transparent
}
button::before{
  content:'';
  position:absolute;
  top:50%;
  left:50%;
  width:0;
  height:0;
  border-radius:50%;
  background:rgba(255,255,255,.3);
  transform:translate(-50%,-50%);
  transition:width .5s,height .5s
}
button:hover{
  transform:translateY(-2px);
  box-shadow:0 12px 30px rgba(102,126,234,.4)
}
button:hover::before{
  width:300px;
  height:300px
}
button:active{
  transform:scale(.98)
}

/* TABLE */
table{
  width:100%;
  margin-top:20px;
  border-collapse:collapse;
  border-radius:12px;
  overflow:hidden;
  font-size:.88rem;
  box-shadow:0 4px 16px rgba(0,0,0,.08)
}
thead{
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:#fff
}
thead th{
  padding:12px 8px;
  text-align:center;
  font-size:.75rem;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.8px;
  border:none
}
tbody td{
  padding:12px 8px;
  text-align:center;
  border-bottom:1px solid #f1f5f9;
  color:#475569;
  font-weight:500;
  vertical-align:middle
}
tbody tr{
  background:#fff;
  transition:background-color .2s
}
tbody tr:nth-child(even){
  background:#f8fafc
}
tbody tr:hover{
  background:linear-gradient(90deg,#f0f4ff,#faf5ff)
}
tbody button{
  width:auto;
  padding:6px 12px;
  margin:2px;
  font-size:.75rem;
  min-height:auto;
  border-radius:8px;
  letter-spacing:.5px
}
tbody button[style*="ff9800"]{
  background:linear-gradient(135deg,#fb8c00,#f57c00)!important
}
tbody button[style*="c62828"]{
  background:linear-gradient(135deg,#e53935,#c62828)!important
}

/* UTILITIES */
.hidden{
  display:none
}

/* MOBILE */
@media(max-width:600px){
  body{padding:12px 0 30px}
  .container{padding:0 12px}
  h2{font-size:1.6rem;margin-bottom:16px}
  h3{font-size:1.05rem;margin-bottom:12px}
  .card{padding:18px;margin-bottom:16px;border-radius:16px}
  input,select{padding:11px 14px;font-size:.9rem}
  button{padding:12px 16px;font-size:.9rem;letter-spacing:.6px}
  table{font-size:.8rem;display:block;overflow-x:auto;-webkit-overflow-scrolling:touch}
  thead th{padding:10px 6px;font-size:.7rem}
  tbody td{padding:10px 6px}
  tbody button{padding:5px 10px;font-size:.7rem;margin:1px}
}

@media(max-width:400px){
  h2{font-size:1.4rem}
  h3{font-size:.95rem}
  .card{padding:14px}
  table{font-size:.75rem}
  thead th{font-size:.65rem;padding:8px 4px}
  tbody td{padding:8px 4px}
}
</style>
</head>

<body>
<div class="container">
  <!-- LOGIN -->
  <div class="card" id="loginBox">
    <h2>ðŸ”’ Login Admin</h2>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">LOGIN</button>
  </div>

  <!-- PANEL -->
  <div id="panelBox" style="display:none">
    <!-- TANGGAL -->
    <div class="card">
      <h3>ðŸ“… Tanggal Laporan</h3>
      <input type="date" id="tanggalInput">
    </div>

    <!-- ABSENSI -->
    <div class="card">
      <h3>ðŸ‘¥ Absensi</h3>
      <input id="absenNama" placeholder="Nama Anggota">
      <select id="absenStatus">
        <option value="Hadir">Hadir</option>
        <option value="Tidak Hadir">Tidak Hadir</option>
      </select>
      <button onclick="simpanAbsensi()" id="btnSimpanAbsensi">Simpan Absensi</button>
      <table style="margin-top:16px;width:100%;font-size:0.98rem;">
        <thead>
          <tr><th>Nama</th><th>Status</th><th>Aksi</th></tr>
        </thead>
        <tbody id="tabelAbsensiAdmin"></tbody>
      </table>
    </div>

    <!-- PEMANEN -->
    <div class="card">
      <h3>ðŸŒ´ Pemanen</h3>
      <input id="namaPemanen" placeholder="Nama">
      <input id="blokPemanen" placeholder="Blok">
      <input id="jumlahPemanen" type="number" placeholder="Jumlah">
      <select id="jenisPemanen">
        <option value="Janjang">Janjang</option>
        <option value="Brondol">Brondol</option>
      </select>
      <input id="keteranganPemanen" placeholder="Keterangan (opsional)">
      <select id="statusPemanen">
        <option value="Selesai">Selesai</option>
        <option value="Belum">Belum</option>
      </select>
      <button onclick="simpanPemanen()" id="btnSimpanPemanen">Simpan Pemanen</button>
      <table style="margin-top:16px;width:100%;font-size:0.98rem;">
        <thead>
          <tr><th>Nama</th><th>Blok</th><th>Jumlah</th><th>Jenis</th><th>Keterangan</th><th>Status</th><th>Aksi</th></tr>
        </thead>
        <tbody id="tabelPemanenAdmin"></tbody>
      </table>
    </div>

    <!-- SEMPROT / TEBAS -->
    <div class="card">
      <h3>ðŸŒ¿ Semprot / Tebas</h3>
      <select id="jenisKerja">
        <option value="semprot">Semprot</option>
        <option value="tebas">Tebas</option>
      </select>
      <input id="anggotaKerja" type="number" placeholder="Jumlah Anggota" oninput="cekAnggota()">
      <div id="namaTunggalBox" class="hidden">
        <input id="namaTunggal" placeholder="Nama Anggota">
      </div>
      <input id="blokKerja" placeholder="Blok">
      <select id="statusKerja">
        <option value="Selesai">Selesai</option>
        <option value="Belum">Belum</option>
      </select>
      <label>ðŸ“· Upload Foto Kegiatan</label>
      <input type="file" id="fotoKerja" accept="image/*">
      <button onclick="simpanKerja()" id="btnSimpanKerja">Simpan Semprot / Tebas</button>
      <table style="margin-top:16px;width:100%;font-size:0.98rem;">
        <thead>
          <tr><th>Jenis</th><th>Blok</th><th>Anggota</th><th>Nama</th><th>Status</th><th>Foto</th><th>Aksi</th></tr>
        </thead>
        <tbody id="tabelKerjaAdmin"></tbody>
      </table>
    </div>

    <div class="card">
      <button onclick="logout()">LOGOUT</button>
    </div>
  </div>
</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCazwLdErOX7aYw3qh8VSyOsdV5i13S3nQ",
  authDomain: "tools-mandor-sawit.firebaseapp.com",
  projectId: "tools-mandor-sawit",
  storageBucket: "tools-mandor-sawit.firebasestorage.app",
  messagingSenderId: "627595048726",
  appId: "1:627595048726:web:3722898b86cd2474634237"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* ================= UTIL ================= */
function today(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

/* ================= AUTH ================= */
window.login = function login(){
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const loginBox = document.getElementById('loginBox');
  const panelBox = document.getElementById('panelBox');
  const tanggalInput = document.getElementById('tanggalInput');
  
  if(!emailInput.value || !passwordInput.value) {
    alert('Email dan password harus diisi!');
    return;
  }
  
  auth.signInWithEmailAndPassword(emailInput.value, passwordInput.value)
    .then(()=>{
      loginBox.style.display="none";
      panelBox.style.display="block";
      tanggalInput.value=today();
      // Render data untuk tanggal hari ini
      renderAbsensiAdmin();
      renderPemanenAdmin();
      renderKerjaAdmin();
    })
    .catch(e=>alert('Login gagal: ' + e.message));
}
window.logout = function logout(){
  auth.signOut().then(()=>location.reload());
}

/* ================= LOGIC ANGGOTA ================= */
function cekAnggota(){
  const jumlah = Number(anggotaKerja.value);
  document.getElementById("namaTunggalBox").classList.toggle("hidden", jumlah !== 1);
}

/* ================= ABSENSI ================= */
function renderAbsensiAdmin() {
  const tgl = tanggalInput.value;
  if(!tgl) return;
  db.collection("absensi").where("tanggal","==",tgl).get().then(snap => {
    const tbody = document.getElementById("tabelAbsensiAdmin");
    tbody.innerHTML = "";
    if(snap.empty) {
      tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#94a3b8;padding:20px">Belum ada data untuk tanggal ini</td></tr>';
      return;
    }
    snap.forEach(doc => {
      const d = doc.data();
      tbody.innerHTML += `<tr>
        <td>${d.nama}</td>
        <td>${d.status}</td>
        <td>
          <button style='background:#ff9800;margin-right:4px;' onclick="editAbsensi('${doc.id}','${d.nama}','${d.status}')">Edit</button>
          <button style='background:#c62828;' onclick="hapusAbsensi('${doc.id}')">Hapus</button>
        </td>
      </tr>`;
    });
  });
}
function hapusAbsensi(id) {
  if(confirm('Yakin hapus data ini?')) {
    db.collection("absensi").doc(id).delete().then(renderAbsensiAdmin);
  }
}
let absensiEditId = null;
function editAbsensi(id, nama, status) {
  absensiEditId = id;
  absenNama.value = nama;
  absenStatus.value = status;
  document.getElementById("btnSimpanAbsensi").innerText = "Update Absensi";
}
function simpanAbsensi(){
  if(absensiEditId) {
    db.collection("absensi").doc(absensiEditId).update({
      nama: absenNama.value,
      status: absenStatus.value
    }).then(()=>{
      absensiEditId = null;
      absenNama.value = "";
      absenStatus.value = "Hadir";
      document.getElementById("btnSimpanAbsensi").innerText = "Simpan Absensi";
      renderAbsensiAdmin();
    });
  } else {
    db.collection("absensi").add({
      tanggal: tanggalInput.value,
      nama: absenNama.value,
      status: absenStatus.value
    }).then(()=>{
      absenNama.value = "";
      absenStatus.value = "Hadir";
      renderAbsensiAdmin();
    });
  }
}

/* ================= PEMANEN ================= */
function renderPemanenAdmin() {
  const tgl = tanggalInput.value;
  if(!tgl) return;
  db.collection("pemanen").where("tanggal","==",tgl).get().then(snap => {
    const tbody = document.getElementById("tabelPemanenAdmin");
    tbody.innerHTML = "";
    if(snap.empty) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#94a3b8;padding:20px">Belum ada data untuk tanggal ini</td></tr>';
      return;
    }
    snap.forEach(doc => {
      const d = doc.data();
      tbody.innerHTML += `<tr>
        <td>${d.nama}</td>
        <td>${d.blok}</td>
        <td>${d.jumlah}</td>
        <td>${d.jenis}</td>
        <td>${d.keterangan ? d.keterangan : "-"}</td>
        <td>${d.status}</td>
        <td>
          <button style='background:#ff9800;margin-right:4px;' onclick="editPemanen(${JSON.stringify(doc.id)},${JSON.stringify(d.nama)},${JSON.stringify(d.blok)},${JSON.stringify(d.jumlah)},${JSON.stringify(d.jenis)},${JSON.stringify(d.keterangan ? d.keterangan : '')},${JSON.stringify(d.status)})">Edit</button>
          <button style='background:#c62828;' onclick="hapusPemanen('${doc.id}')">Hapus</button>
        </td>
      </tr>`;
    });
  });
}
function hapusPemanen(id) {
  if(confirm('Yakin hapus data ini?')) {
    db.collection("pemanen").doc(id).delete().then(renderPemanenAdmin);
  }
}
let pemanenEditId = null;
function editPemanen(id, nama, blok, jumlah, jenis, keterangan, status) {
  pemanenEditId = id;
  namaPemanen.value = nama;
  blokPemanen.value = blok;
  jumlahPemanen.value = jumlah;
  jenisPemanen.value = jenis;
  keteranganPemanen.value = keterangan;
  statusPemanen.value = status;
  document.getElementById("btnSimpanPemanen").innerText = "Update Pemanen";
}
function simpanPemanen(){
  if(pemanenEditId) {
    db.collection("pemanen").doc(pemanenEditId).update({
      nama: namaPemanen.value,
      blok: blokPemanen.value,
      jumlah: Number(jumlahPemanen.value),
      jenis: jenisPemanen.value,
      keterangan: keteranganPemanen.value,
      status: statusPemanen.value
    }).then(()=>{
      pemanenEditId = null;
      namaPemanen.value = "";
      blokPemanen.value = "";
      jumlahPemanen.value = "";
      jenisPemanen.value = "Janjang";
      keteranganPemanen.value = "";
      statusPemanen.value = "Selesai";
      document.getElementById("btnSimpanPemanen").innerText = "Simpan Pemanen";
      renderPemanenAdmin();
    });
  } else {
    db.collection("pemanen").add({
      tanggal: tanggalInput.value,
      nama: namaPemanen.value,
      blok: blokPemanen.value,
      jumlah: Number(jumlahPemanen.value),
      jenis: jenisPemanen.value,
      keterangan: keteranganPemanen.value,
      status: statusPemanen.value
    }).then(()=>{
      namaPemanen.value = "";
      blokPemanen.value = "";
      jumlahPemanen.value = "";
      jenisPemanen.value = "Janjang";
      keteranganPemanen.value = "";
      statusPemanen.value = "Selesai";
      renderPemanenAdmin();
    });
  }
}

/* ================= UPLOAD FOTO ================= */
async function uploadFoto(file,path){
  if(!file) return "";
  const ref = storage.ref(path);
  await ref.put(file);
  return await ref.getDownloadURL();
}

/* ================= SEMPROT / TEBAS ================= */
function renderKerjaAdmin() {
  const tgl = tanggalInput.value;
  if(!tgl) return;
  const tbody = document.getElementById("tabelKerjaAdmin");
  tbody.innerHTML = "";
  
  Promise.all([
    db.collection("semprot").where("tanggal","==",tgl).get(),
    db.collection("tebas").where("tanggal","==",tgl).get()
  ]).then(([snapSemprot, snapTebas]) => {
    if(snapSemprot.empty && snapTebas.empty) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#94a3b8;padding:20px">Belum ada data untuk tanggal ini</td></tr>';
      return;
    }
    
    snapSemprot.forEach(doc => {
      const d = doc.data();
      tbody.innerHTML += `<tr>
        <td>Semprot</td>
        <td>${d.blok}</td>
        <td>${d.anggota}</td>
        <td>${d.nama || "-"}</td>
        <td>${d.status}</td>
        <td>${d.foto ? '<a href="' + d.foto + '" target="_blank">Lihat</a>' : "-"}</td>
        <td>
          <button style='background:#ff9800;margin-right:4px;' onclick="editKerja('${doc.id}','semprot','${d.blok}',${d.anggota},'${d.nama || ''}','${d.status}')">Edit</button>
          <button style='background:#c62828;' onclick="hapusKerja('${doc.id}','semprot')">Hapus</button>
        </td>
      </tr>`;
    });
    
    snapTebas.forEach(doc => {
      const d = doc.data();
      tbody.innerHTML += `<tr>
        <td>Tebas</td>
        <td>${d.blok}</td>
        <td>${d.anggota}</td>
        <td>${d.nama || "-"}</td>
        <td>${d.status}</td>
        <td>${d.foto ? '<a href="' + d.foto + '" target="_blank">Lihat</a>' : "-"}</td>
        <td>
          <button style='background:#ff9800;margin-right:4px;' onclick="editKerja('${doc.id}','tebas','${d.blok}',${d.anggota},'${d.nama || ''}','${d.status}')">Edit</button>
          <button style='background:#c62828;' onclick="hapusKerja('${doc.id}','tebas')">Hapus</button>
        </td>
      </tr>`;
    });
  });
}
  ["semprot","tebas"].forEach(jenis => {
    db.collection(jenis).orderBy("tanggal","desc").limit(20).get().then(snap => {
      snap.forEach(doc => {
        const d = doc.data();
        tbody.innerHTML += `<tr>
          <td>${jenis.charAt(0).toUpperCase()+jenis.slice(1)}</td>
          <td>${d.blok}</td>
          <td>${d.anggota}</td>
          <td>${d.nama ? d.nama : "-"}</td>
          <td>${d.status}</td>
          <td>${d.foto ? `<a href='${d.foto}' target='_blank'>Lihat</a>` : "-"}</td>
          <td>
            <button style='background:#ff9800;margin-right:4px;' onclick="editKerja(${JSON.stringify(doc.id)},${JSON.stringify(jenis)},${JSON.stringify(d.blok)},${JSON.stringify(d.anggota)},${JSON.stringify(d.nama ? d.nama : '')},${JSON.stringify(d.status)})">Edit</button>
            <button style='background:#c62828;' onclick="hapusKerja('${doc.id}','${jenis}')">Hapus</button>
          </td>
        </tr>`;
      });
    });
  });
}
function hapusKerja(id, jenis) {
  if(confirm('Yakin hapus data ini?')) {
    db.collection(jenis).doc(id).delete().then(renderKerjaAdmin);
  }
}
let kerjaEditId = null;
let kerjaEditJenis = null;
function editKerja(id, jenis, blok, anggota, nama, status) {
  kerjaEditId = id;
  kerjaEditJenis = jenis;
  jenisKerja.value = jenis;
  blokKerja.value = blok;
  anggotaKerja.value = anggota;
  namaTunggal.value = nama;
  statusKerja.value = status;
  document.getElementById("btnSimpanKerja").innerText = "Update Kerja";
}
async function simpanKerja(){
  const jumlah = Number(anggotaKerja.value);
  let fotoURL = "";
  if(fotoKerja.files[0]){
    fotoURL = await uploadFoto(
      fotoKerja.files[0],
      `kerja/${jenisKerja.value}/${Date.now()}`
    );
  }
  if(kerjaEditId && kerjaEditJenis) {
    db.collection(kerjaEditJenis).doc(kerjaEditId).update({
      tanggal: tanggalInput.value,
      blok: blokKerja.value,
      anggota: jumlah,
      nama: jumlah === 1 ? namaTunggal.value : "",
      status: statusKerja.value,
      foto: fotoURL
    }).then(()=>{
      kerjaEditId = null;
      kerjaEditJenis = null;
      jenisKerja.value = "semprot";
      blokKerja.value = "";
      anggotaKerja.value = "";
      namaTunggal.value = "";
      statusKerja.value = "Selesai";
      document.getElementById("btnSimpanKerja").innerText = "Simpan Semprot / Tebas";
      renderKerjaAdmin();
    });
  } else {
    db.collection(jenisKerja.value).add({
      tanggal: tanggalInput.value,
      blok: blokKerja.value,
      anggota: jumlah,
      nama: jumlah === 1 ? namaTunggal.value : "",
      status: statusKerja.value,
      foto: fotoURL
    }).then(()=>{
      jenisKerja.value = "semprot";
      blokKerja.value = "";
      anggotaKerja.value = "";
      namaTunggal.value = "";
      statusKerja.value = "Selesai";
      renderKerjaAdmin();
    });
  }
}

window.addEventListener('DOMContentLoaded', function() {
  // Event listener untuk perubahan tanggal
  const tanggalInputElement = document.getElementById('tanggalInput');
  if(tanggalInputElement) {
    tanggalInputElement.addEventListener('change', function() {
      renderAbsensiAdmin();
      renderPemanenAdmin();
      renderKerjaAdmin();
    });
  }
});
</script>

</body>
</html>
