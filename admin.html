<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Mandor Sawit</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: #f1f5f9;
  padding: 0;
  margin: 0;
}
h2 {
  text-align: center;
  margin-top: 24px;
  font-size: 2rem;
}
.container {
  max-width: 480px;
  margin: 0 auto;
  padding: 16px;
}
.card {
  background: #fff;
  padding: 20px 16px;
  border-radius: 12px;
  margin-bottom: 24px;
  box-shadow: 0 2px 12px rgba(0,0,0,.07);
}
input, select, button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 1rem;
  box-sizing: border-box;
}
button {
  background: linear-gradient(90deg, #388e3c 0%, #1b5e20 100%);
  color: #fff;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s;
}
button:hover {
  background: linear-gradient(90deg, #43a047 0%, #1b5e20 100%);
}
label {
  font-size: 15px;
  color: #333;
  margin-top: 12px;
}
.hidden {
  display: none;
}
@media (max-width: 600px) {
  .container {
    max-width: 100%;
    padding: 8px;
  }
  .card {
    padding: 14px 8px;
    margin-bottom: 16px;
  }
  h2 {
    font-size: 1.3rem;
    margin-top: 12px;
  }
  input, select, button {
    font-size: 0.95rem;
    padding: 10px;
  }
}
</style>
</head>

<body>
<div class="container">
  <!-- LOGIN -->
  <div class="card" id="loginBox">
    <h2>ðŸ”’ Login Admin</h2>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">LOGIN</button>
  </div>

  <!-- PANEL -->
  <div id="panelBox" style="display:none">
    <!-- TANGGAL -->
    <div class="card">
      <h3>ðŸ“… Tanggal Laporan</h3>
      <input type="date" id="tanggalInput">
    </div>

    <!-- ABSENSI -->
    <div class="card">
      <h3>ðŸ‘¥ Absensi</h3>
      <input id="absenNama" placeholder="Nama Anggota">
      <select id="absenStatus">
        <option value="Hadir">Hadir</option>
        <option value="Tidak Hadir">Tidak Hadir</option>
      </select>
      <button onclick="simpanAbsensi()" id="btnSimpanAbsensi">Simpan Absensi</button>
      <table style="margin-top:16px;width:100%;font-size:0.98rem;">
        <thead>
          <tr><th>Nama</th><th>Status</th><th>Aksi</th></tr>
        </thead>
        <tbody id="tabelAbsensiAdmin"></tbody>
      </table>
    </div>

    <!-- PEMANEN -->
    <div class="card">
      <h3>ðŸŒ´ Pemanen</h3>
      <input id="namaPemanen" placeholder="Nama">
      <input id="blokPemanen" placeholder="Blok">
      <input id="jumlahPemanen" type="number" placeholder="Jumlah">
      <select id="jenisPemanen">
        <option value="Janjang">Janjang</option>
        <option value="Brondol">Brondol</option>
      </select>
      <input id="keteranganPemanen" placeholder="Keterangan (opsional)">
      <select id="statusPemanen">
        <option value="Selesai">Selesai</option>
        <option value="Belum">Belum</option>
      </select>
      <button onclick="simpanPemanen()" id="btnSimpanPemanen">Simpan Pemanen</button>
      <table style="margin-top:16px;width:100%;font-size:0.98rem;">
        <thead>
          <tr><th>Nama</th><th>Blok</th><th>Jumlah</th><th>Jenis</th><th>Keterangan</th><th>Status</th><th>Aksi</th></tr>
        </thead>
        <tbody id="tabelPemanenAdmin"></tbody>
      </table>
    </div>

    <!-- SEMPROT / TEBAS -->
    <div class="card">
      <h3>ðŸŒ¿ Semprot / Tebas</h3>
      <select id="jenisKerja">
        <option value="semprot">Semprot</option>
        <option value="tebas">Tebas</option>
      </select>
      <input id="anggotaKerja" type="number" placeholder="Jumlah Anggota" oninput="cekAnggota()">
      <div id="namaTunggalBox" class="hidden">
        <input id="namaTunggal" placeholder="Nama Anggota">
      </div>
      <input id="blokKerja" placeholder="Blok">
      <select id="statusKerja">
        <option value="Selesai">Selesai</option>
        <option value="Belum">Belum</option>
      </select>
      <label>ðŸ“· Upload Foto Kegiatan</label>
      <input type="file" id="fotoKerja" accept="image/*">
      <button onclick="simpanKerja()" id="btnSimpanKerja">Simpan Semprot / Tebas</button>
      <table style="margin-top:16px;width:100%;font-size:0.98rem;">
        <thead>
          <tr><th>Jenis</th><th>Blok</th><th>Anggota</th><th>Nama</th><th>Status</th><th>Foto</th><th>Aksi</th></tr>
        </thead>
        <tbody id="tabelKerjaAdmin"></tbody>
      </table>
    </div>

    <div class="card">
      <button onclick="logout()">LOGOUT</button>
    </div>
  </div>
</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCazwLdErOX7aYw3qh8VSyOsdV5i13S3nQ",
  authDomain: "tools-mandor-sawit.firebaseapp.com",
  projectId: "tools-mandor-sawit",
  storageBucket: "tools-mandor-sawit.firebasestorage.app",
  messagingSenderId: "627595048726",
  appId: "1:627595048726:web:3722898b86cd2474634237"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* ================= UTIL ================= */
function today(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

/* ================= AUTH ================= */
window.login = function login(){
  auth.signInWithEmailAndPassword(email.value,password.value)
    .then(()=>{
      loginBox.style.display="none";
      panelBox.style.display="block";
      tanggalInput.value=today();
    })
    .catch(e=>alert(e.message));
}
window.logout = function logout(){
  auth.signOut().then(()=>location.reload());
}

/* ================= LOGIC ANGGOTA ================= */
function cekAnggota(){
  const jumlah = Number(anggotaKerja.value);
  document.getElementById("namaTunggalBox").classList.toggle("hidden", jumlah !== 1);
}

/* ================= ABSENSI ================= */
function renderAbsensiAdmin() {
  db.collection("absensi").orderBy("tanggal","desc").limit(20).get().then(snap => {
    const tbody = document.getElementById("tabelAbsensiAdmin");
    tbody.innerHTML = "";
    snap.forEach(doc => {
      const d = doc.data();
      tbody.innerHTML += `<tr>
        <td>${d.nama}</td>
        <td>${d.status}</td>
        <td>
          <button style='background:#ff9800;margin-right:4px;' onclick="editAbsensi('${doc.id}','${d.nama}','${d.status}')">Edit</button>
          <button style='background:#c62828;' onclick="hapusAbsensi('${doc.id}')">Hapus</button>
        </td>
      </tr>`;
    });
  });
}
function hapusAbsensi(id) {
  if(confirm('Yakin hapus data ini?')) {
    db.collection("absensi").doc(id).delete().then(renderAbsensiAdmin);
  }
}
let absensiEditId = null;
function editAbsensi(id, nama, status) {
  absensiEditId = id;
  absenNama.value = nama;
  absenStatus.value = status;
  document.getElementById("btnSimpanAbsensi").innerText = "Update Absensi";
}
function simpanAbsensi(){
  if(absensiEditId) {
    db.collection("absensi").doc(absensiEditId).update({
      nama: absenNama.value,
      status: absenStatus.value
    }).then(()=>{
      absensiEditId = null;
      absenNama.value = "";
      absenStatus.value = "Hadir";
      document.getElementById("btnSimpanAbsensi").innerText = "Simpan Absensi";
      renderAbsensiAdmin();
    });
  } else {
    db.collection("absensi").add({
      tanggal: tanggalInput.value,
      nama: absenNama.value,
      status: absenStatus.value
    }).then(()=>{
      absenNama.value = "";
      absenStatus.value = "Hadir";
      renderAbsensiAdmin();
    });
  }
}
window.addEventListener('DOMContentLoaded', renderAbsensiAdmin);

/* ================= PEMANEN ================= */
function renderPemanenAdmin() {
  db.collection("pemanen").orderBy("tanggal","desc").limit(30).get().then(snap => {
    const tbody = document.getElementById("tabelPemanenAdmin");
    tbody.innerHTML = "";
    snap.forEach(doc => {
      const d = doc.data();
      tbody.innerHTML += `<tr>
        <td>${d.nama}</td>
        <td>${d.blok}</td>
        <td>${d.jumlah}</td>
        <td>${d.jenis}</td>
        <td>${d.keterangan ? d.keterangan : "-"}</td>
        <td>${d.status}</td>
        <td>
          <button style='background:#ff9800;margin-right:4px;' onclick="editPemanen(${JSON.stringify(doc.id)},${JSON.stringify(d.nama)},${JSON.stringify(d.blok)},${JSON.stringify(d.jumlah)},${JSON.stringify(d.jenis)},${JSON.stringify(d.keterangan ? d.keterangan : '')},${JSON.stringify(d.status)})">Edit</button>
          <button style='background:#c62828;' onclick="hapusPemanen('${doc.id}')">Hapus</button>
        </td>
      </tr>`;
    });
  });
}
function hapusPemanen(id) {
  if(confirm('Yakin hapus data ini?')) {
    db.collection("pemanen").doc(id).delete().then(renderPemanenAdmin);
  }
}
let pemanenEditId = null;
function editPemanen(id, nama, blok, jumlah, jenis, keterangan, status) {
  pemanenEditId = id;
  namaPemanen.value = nama;
  blokPemanen.value = blok;
  jumlahPemanen.value = jumlah;
  jenisPemanen.value = jenis;
  keteranganPemanen.value = keterangan;
  statusPemanen.value = status;
  document.getElementById("btnSimpanPemanen").innerText = "Update Pemanen";
}
function simpanPemanen(){
  if(pemanenEditId) {
    db.collection("pemanen").doc(pemanenEditId).update({
      nama: namaPemanen.value,
      blok: blokPemanen.value,
      jumlah: Number(jumlahPemanen.value),
      jenis: jenisPemanen.value,
      keterangan: keteranganPemanen.value,
      status: statusPemanen.value
    }).then(()=>{
      pemanenEditId = null;
      namaPemanen.value = "";
      blokPemanen.value = "";
      jumlahPemanen.value = "";
      jenisPemanen.value = "Janjang";
      keteranganPemanen.value = "";
      statusPemanen.value = "Selesai";
      document.getElementById("btnSimpanPemanen").innerText = "Simpan Pemanen";
      renderPemanenAdmin();
    });
  } else {
    db.collection("pemanen").add({
      tanggal: tanggalInput.value,
      nama: namaPemanen.value,
      blok: blokPemanen.value,
      jumlah: Number(jumlahPemanen.value),
      jenis: jenisPemanen.value,
      keterangan: keteranganPemanen.value,
      status: statusPemanen.value
    }).then(()=>{
      namaPemanen.value = "";
      blokPemanen.value = "";
      jumlahPemanen.value = "";
      jenisPemanen.value = "Janjang";
      keteranganPemanen.value = "";
      statusPemanen.value = "Selesai";
      renderPemanenAdmin();
    });
  }
}

/* ================= UPLOAD FOTO ================= */
async function uploadFoto(file,path){
  if(!file) return "";
  const ref = storage.ref(path);
  await ref.put(file);
  return await ref.getDownloadURL();
}

/* ================= SEMPROT / TEBAS ================= */
function renderKerjaAdmin() {
  const tbody = document.getElementById("tabelKerjaAdmin");
  tbody.innerHTML = "";
  ["semprot","tebas"].forEach(jenis => {
    db.collection(jenis).orderBy("tanggal","desc").limit(20).get().then(snap => {
      snap.forEach(doc => {
        const d = doc.data();
        tbody.innerHTML += `<tr>
          <td>${jenis.charAt(0).toUpperCase()+jenis.slice(1)}</td>
          <td>${d.blok}</td>
          <td>${d.anggota}</td>
          <td>${d.nama ? d.nama : "-"}</td>
          <td>${d.status}</td>
          <td>${d.foto ? `<a href='${d.foto}' target='_blank'>Lihat</a>` : "-"}</td>
          <td>
            <button style='background:#ff9800;margin-right:4px;' onclick="editKerja(${JSON.stringify(doc.id)},${JSON.stringify(jenis)},${JSON.stringify(d.blok)},${JSON.stringify(d.anggota)},${JSON.stringify(d.nama ? d.nama : '')},${JSON.stringify(d.status)})">Edit</button>
            <button style='background:#c62828;' onclick="hapusKerja('${doc.id}','${jenis}')">Hapus</button>
          </td>
        </tr>`;
      });
    });
  });
}
function hapusKerja(id, jenis) {
  if(confirm('Yakin hapus data ini?')) {
    db.collection(jenis).doc(id).delete().then(renderKerjaAdmin);
  }
}
let kerjaEditId = null;
let kerjaEditJenis = null;
function editKerja(id, jenis, blok, anggota, nama, status) {
  kerjaEditId = id;
  kerjaEditJenis = jenis;
  jenisKerja.value = jenis;
  blokKerja.value = blok;
  anggotaKerja.value = anggota;
  namaTunggal.value = nama;
  statusKerja.value = status;
  document.getElementById("btnSimpanKerja").innerText = "Update Kerja";
}
async function simpanKerja(){
  const jumlah = Number(anggotaKerja.value);
  let fotoURL = "";
  if(fotoKerja.files[0]){
    fotoURL = await uploadFoto(
      fotoKerja.files[0],
      `kerja/${jenisKerja.value}/${Date.now()}`
    );
  }
  if(kerjaEditId && kerjaEditJenis) {
    db.collection(kerjaEditJenis).doc(kerjaEditId).update({
      tanggal: tanggalInput.value,
      blok: blokKerja.value,
      anggota: jumlah,
      nama: jumlah === 1 ? namaTunggal.value : "",
      status: statusKerja.value,
      foto: fotoURL
    }).then(()=>{
      kerjaEditId = null;
      kerjaEditJenis = null;
      jenisKerja.value = "semprot";
      blokKerja.value = "";
      anggotaKerja.value = "";
      namaTunggal.value = "";
      statusKerja.value = "Selesai";
      document.getElementById("btnSimpanKerja").innerText = "Simpan Semprot / Tebas";
      renderKerjaAdmin();
    });
  } else {
    db.collection(jenisKerja.value).add({
      tanggal: tanggalInput.value,
      blok: blokKerja.value,
      anggota: jumlah,
      nama: jumlah === 1 ? namaTunggal.value : "",
      status: statusKerja.value,
      foto: fotoURL
    }).then(()=>{
      jenisKerja.value = "semprot";
      blokKerja.value = "";
      anggotaKerja.value = "";
      namaTunggal.value = "";
      statusKerja.value = "Selesai";
      renderKerjaAdmin();
    });
  }
}

window.addEventListener('DOMContentLoaded', function() {
  renderAbsensiAdmin();
  renderPemanenAdmin();
  renderKerjaAdmin();
});
</script>

</body>
</html>
