<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Laporan Sawit</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  font-family:'Segoe UI',system-ui,Arial,sans-serif;
  background:#f1f5f9;
  margin:0;color:#1f2937
}
h2{text-align:center;margin:22px 0 4px}
.subtitle{text-align:center;color:#6b7280;margin-bottom:18px}
.container{max-width:1100px;margin:auto;padding:14px}

.card{
  background:#fff;
  padding:18px;
  border-radius:16px;
  margin-bottom:18px;
  box-shadow:0 8px 20px rgba(0,0,0,.06)
}
.section-title{font-weight:700;margin-bottom:10px;color:#14532d}

.filter{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:12px
}
.filter input{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid #d1d5db
}

.summary{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
  gap:14px
}
.summary .box{
  background:#ecfdf5;
  border-radius:14px;
  padding:16px;
  text-align:center
}
.summary h4{margin:0;font-size:.85rem;color:#166534}
.summary b{font-size:1.4rem;display:block;margin-top:6px}

table{
  width:100%;
  border-collapse:collapse;
  font-size:.92rem
}
thead th{
  background:#14532d;
  color:#fff;
  padding:10px;
  text-align:center
}
tbody td{
  padding:10px;
  border-bottom:1px solid #e5e7eb;
  text-align:center
}
tbody tr:nth-child(even){background:#f9fafb}

tfoot td{
  padding:12px;
  font-weight:700;
  text-align:center;
  background:#ecfdf5
}

.badge{
  padding:4px 12px;
  border-radius:999px;
  font-size:.7rem;
  font-weight:700
}
.hadir{background:#dbeafe;color:#1e40af}
.tidak{background:#fee2e2;color:#991b1b}
.selesai{background:#dcfce7;color:#14532d}
.belum{background:#fee2e2;color:#991b1b}

.progress-box{
  background:#ecfdf5;
  border-radius:14px;
  padding:14px
}
.progress-bar{
  height:14px;
  background:#e5e7eb;
  border-radius:999px;
  overflow:hidden
}
.progress-bar span{
  display:block;
  height:100%;
  background:#22c55e;
  width:0%
}
.progress-text{text-align:center;font-weight:700;margin-top:6px}

button{
  padding:8px 14px;
  border:none;
  border-radius:10px;
  background:#14532d;
  color:#fff;
  font-weight:600;
  cursor:pointer
}
button.secondary{background:#334155}

footer{
  text-align:center;
  padding:16px;
  font-size:.8rem;
  color:#6b7280
}

@media(max-width:700px){
  table{display:block;overflow-x:auto;white-space:nowrap}
}
</style>
</head>

<body>
<h2>ðŸ“Š Dashboard Laporan Sawit</h2>
<div class="subtitle">Rekap & Monitoring Panen</div>

<div class="container" id="areaExport">

<!-- FILTER -->
<div class="card">
  <div class="filter">
    <b>Tanggal</b>
    <input type="date" id="tanggal">
  </div>
</div>

<!-- RINGKASAN -->
<div class="card">
  <div class="summary">
    <div class="box"><h4>Hari Ini</h4><b id="sumHari">0</b></div>
    <div class="box"><h4>7 Hari</h4><b id="sum7">0</b></div>
    <div class="box"><h4>Bulan Ini</h4><b id="sumBulan">0</b></div>
    <div class="box"><h4>Bulan Lalu</h4><b id="sumLalu">0</b></div>
  </div>
</div>

<!-- ABSENSI -->
<div class="card">
  <div class="section-title">ABSENSI</div>
  <table>
    <thead><tr><th>Nama</th><th>Status</th></tr></thead>
    <tbody id="tabelAbsensi"></tbody>
  </table>
</div>

<!-- PEMANEN -->
<div class="card">
  <div class="section-title">PEMANEN</div>
  <table>
    <thead><tr><th>Nama</th><th>Blok</th><th>Janjang</th><th>Status</th></tr></thead>
    <tbody id="tabelPemanen"></tbody>
    <tfoot><tr><td colspan="2">TOTAL</td><td id="totalJanjang">0</td><td></td></tr></tfoot>
  </table>
</div>

<!-- BRONDOL -->
<div class="card">
  <div class="section-title">KARUNG BRONDOL</div>
  <table>
    <thead><tr><th>Nama</th><th>Jumlah</th><th>Keterangan</th></tr></thead>
    <tbody id="tabelBrondol"></tbody>
    <tfoot><tr><td>TOTAL</td><td id="totalKarung">0</td><td></td></tr></tfoot>
  </table>
</div>

<!-- KERJA -->
<div class="card">
  <div class="section-title">SEMPROT & TEBAS</div>
  <table>
    <thead><tr><th>Jenis</th><th>Blok</th><th>Anggota</th><th>Status</th></tr></thead>
    <tbody id="tabelKerja"></tbody>
  </table>
</div>

<!-- EXPORT -->
<div class="card" style="display:flex;gap:10px">
  <button onclick="exportPDF()">ðŸ“¥ Export PDF</button>
  <button class="secondary" onclick="exportExcel()">ðŸ“Š Export Excel</button>
</div>

<!-- PROGRESS -->
<div class="card">
  <div class="section-title">ðŸ“ˆ Progres Panen Hari Ini</div>
  <div class="progress-box">
    <div class="progress-bar"><span id="progressFill"></span></div>
    <div class="progress-text" id="progressText">0%</div>
  </div>
</div>

</div>

<footer>Â© 2026 Dashboard Mandor Sawit</footer>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCazwLdErOX7aYw3qh8VSyOsdV5i13S3nQ",
  authDomain:"tools-mandor-sawit.firebaseapp.com",
  projectId:"tools-mandor-sawit"
});
const db=firebase.firestore();
const today=()=>new Date().toISOString().slice(0,10);

/* ===== LOAD FUNCTIONS ===== */
async function loadRingkasan(){
  const snap=await db.collection("pemanen").get();
  const now=new Date();
  let h=0,s7=0,bln=0,lalu=0;
  snap.forEach(d=>{
    const v=d.data();
    if(v.jenis!=="Janjang")return;
    const t=new Date(v.tanggal);
    const diff=(now-t)/86400000;
    if(diff<1)h+=v.jumlah;
    if(diff<7)s7+=v.jumlah;
    if(t.getMonth()===now.getMonth()&&t.getFullYear()===now.getFullYear())bln+=v.jumlah;
    const lm=new Date(now.getFullYear(),now.getMonth()-1,1);
    if(t.getMonth()===lm.getMonth()&&t.getFullYear()===lm.getFullYear())lalu+=v.jumlah;
  });
  sumHari.innerText=h+" Tandan";
  sum7.innerText=s7+" Tandan";
  sumBulan.innerText=bln+" Tandan";
  sumLalu.innerText=lalu+" Tandan";
}

async function loadAbsensi(t){
  tabelAbsensi.innerHTML="";
  (await db.collection("absensi").get()).forEach(d=>{
    const v=d.data();
    if(v.tanggal!==t)return;
    tabelAbsensi.innerHTML+=
      `<tr><td>${v.nama}</td><td><span class="badge ${v.status==="Hadir"?"hadir":"tidak"}">${v.status}</span></td></tr>`;
  });
}

async function loadPemanen(t){
  tabelPemanen.innerHTML="";
  let total=0;
  (await db.collection("pemanen").get()).forEach(d=>{
    const v=d.data();
    if(v.tanggal!==t||v.jenis!=="Janjang")return;
    total+=v.jumlah;
    const st=v.status==="Selesai"?"selesai":"belum";
    tabelPemanen.innerHTML+=
      `<tr><td>${v.nama}</td><td>${v.blok}</td><td>${v.jumlah}</td>
       <td><span class="badge ${st}">${v.status||"Belum"}</span></td></tr>`;
  });
  totalJanjang.innerText=total;
}

async function loadBrondol(t){
  tabelBrondol.innerHTML="";
  let total=0;
  (await db.collection("pemanen").get()).forEach(d=>{
    const v=d.data();
    if(v.tanggal!==t||v.jenis!=="Brondol")return;
    total+=v.jumlah;
    tabelBrondol.innerHTML+=
      `<tr><td>${v.nama}</td><td>${v.jumlah}</td><td>${v.keterangan||""}</td></tr>`;
  });
  totalKarung.innerText=total;
}

async function loadKerja(t){
  tabelKerja.innerHTML="";
  (await db.collection("kerja").get()).forEach(d=>{
    const v=d.data();
    if(v.tanggal!==t)return;
    tabelKerja.innerHTML+=
      `<tr><td>${v.jenis}</td><td>${v.blok}</td><td>${v.anggota}</td>
       <td><span class="badge selesai">Selesai</span></td></tr>`;
  });
}

async function loadProgress(){
  const snap=await db.collection("pemanen").get();
  let selesai=0,total=0;
  snap.forEach(d=>{
    const v=d.data();
    if(v.tanggal!==today()||v.jenis!=="Janjang")return;
    total+=v.jumlah;
    if(v.status==="Selesai")selesai+=v.jumlah;
  });
  const p=total?Math.round((selesai/total)*100):0;
  progressFill.style.width=p+"%";
  progressText.innerText=p+"% ("+selesai+"/"+total+" Tandan)";
}

/* ===== LOAD ALL ===== */
function loadAll(){
  const t=tanggal.value;
  loadRingkasan();
  loadAbsensi(t);
  loadPemanen(t);
  loadBrondol(t);
  loadKerja(t);
  loadProgress();
}

/* INIT */
tanggal.value=today();
tanggal.addEventListener("change",loadAll);
loadAll();

/* EXPORT */
async function exportPDF(){
  const { jsPDF }=window.jspdf;
  const pdf=new jsPDF("p","mm","a4");
  const canvas=await html2canvas(areaExport,{scale:2});
  const img=canvas.toDataURL("image/png");
  pdf.addImage(img,"PNG",10,10,190,0);
  pdf.save("laporan-sawit.pdf");
}
function exportExcel(){
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet([{Info:"Dashboard Sawit"}]),"Laporan");
  XLSX.writeFile(wb,"laporan-sawit.xlsx");
}
</script>

</body>
</html>
