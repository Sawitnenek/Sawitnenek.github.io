<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Laporan Sawit</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- CHART -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- EXPORT -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
/* RESET */
*{box-sizing:border-box}
body{
  font-family:'Segoe UI',system-ui,Arial,sans-serif;
  background:linear-gradient(180deg,#f1f5f9,#e6edf5);
  margin:0;color:#1f2937
}
h2{text-align:center;margin:22px 0 4px;font-weight:700}
.subtitle{text-align:center;color:#6b7280;margin-bottom:18px}
.container{max-width:1100px;margin:auto;padding:14px}

/* CARD */
.card{
  background:#fff;
  padding:18px;
  border-radius:18px;
  margin-bottom:18px;
  box-shadow:0 10px 25px rgba(0,0,0,.07)
}

/* FILTER */
.filter{display:flex;justify-content:center;gap:12px;flex-wrap:wrap}
.filter input{
  padding:8px 12px;border-radius:10px;border:1px solid #d1d5db
}

/* RINGKASAN */
.summary{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
  gap:14px
}
.summary .box{
  background:linear-gradient(135deg,#dcfce7,#ecfeff);
  border-radius:16px;
  padding:16px;
  text-align:center;
  border:1px solid #bbf7d0
}
.summary .box h4{margin:0;font-size:.85rem;color:#166534}
.summary .box b{display:block;margin-top:6px;font-size:1.5rem;color:#064e3b}

/* SECTION */
.section-title{font-weight:700;margin-bottom:10px;color:#14532d}

/* TABLE */
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  border-radius:14px;
  overflow:hidden;
  font-size:.92rem
}
thead th{
  background:linear-gradient(135deg,#14532d,#166534);
  color:#fff;
  padding:12px;
  font-size:.75rem;
  letter-spacing:.6px;
  text-align:center
}
tbody td{
  padding:11px;
  border-bottom:1px solid #e5e7eb;
  text-align:center;
  vertical-align:middle
}
tbody tr:nth-child(even){background:#f9fafb}
tbody tr:hover{background:#ecfeff}

/* TOTAL ROW */
tfoot tr{background:#f0fdf4}
tfoot td{
  padding:12px 10px;
  font-weight:700;
  text-align:center;
  border-top:2px solid #bbf7d0;
  color:#14532d
}
.total-number{font-size:1rem;letter-spacing:.6px}

/* BADGE */
.badge{
  padding:5px 12px;
  border-radius:999px;
  font-size:.7rem;
  font-weight:700
}
.hadir{background:#dbeafe;color:#1e40af}
.tidak{background:#fee2e2;color:#991b1b}
.selesai{background:#dcfce7;color:#14532d}
.belum{background:#fee2e2;color:#991b1b}

footer{text-align:center;padding:16px;color:#6b7280;font-size:.8rem}

/* LOADING */
.loading{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999}
.spinner{border:4px solid #f3f3f3;border-top:4px solid #16a34a;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.3);z-index:9998}

/* TOAST */
.toast{position:fixed;top:20px;right:20px;background:#16a34a;color:#fff;padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.2);z-index:10000;opacity:0;transition:.3s;pointer-events:none}
.toast.show{opacity:1;pointer-events:auto}

/* EMPTY STATE */
.empty{text-align:center;padding:30px;color:#9ca3af;font-style:italic}

/* SEARCH */
.search-box{margin-bottom:12px}
.search-box input{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:.9rem}

/* DATE DISPLAY */
.date-display{text-align:center;background:linear-gradient(135deg,#14532d,#166534);color:#fff;padding:16px;border-radius:12px;margin-bottom:18px;font-size:1.1rem;font-weight:600;letter-spacing:.5px;box-shadow:0 4px 12px rgba(20,83,45,.3)}

/* EXPORT HIDE */
.export-hide{transition:opacity .2s}
.exporting .export-hide{display:none!important}

/* EXPORT AREA */
#exportArea{position:relative}
.export-mode{max-width:800px!important;margin:20px auto!important;padding:20px!important;background:#fff!important}

@media(max-width:700px){
  table{display:block;overflow-x:auto;white-space:nowrap}
  h2{font-size:1.25rem}
  .toast{right:10px;top:10px;padding:12px 16px;font-size:.85rem}
}

@media print{
  .filter,.search-box,button,.export-hide{display:none}
  body{background:#fff}
  .card{box-shadow:none;page-break-inside:avoid}
}
</style>
</head>

<body>
<h2>üìä Dashboard Laporan Sawit</h2>
<div class="subtitle">Rekap Harian Kebun</div>

<div class="container">

<!-- DATE DISPLAY -->
<div class="date-display" id="dateDisplay">üìÖ Memuat...</div>

<!-- FILTER -->
<div class="card export-hide">
  <div class="filter">
    <b>Tanggal:</b>
    <input type="date" id="tanggal">
  </div>
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="üîç Cari nama anggota atau blok...">
  </div>
</div>

<!-- EXPORT AREA START -->
<div id="exportArea">

<!-- RINGKASAN -->
<div class="card">
  <div class="summary">
    <div class="box"><h4>üå¥ Hari Ini</h4><b id="sumHari">0</b></div>
    <div class="box"><h4>üìä 7 Hari Terakhir</h4><b id="sum7">0</b></div>
    <div class="box"><h4>üìà Bulan Ini</h4><b id="sumBulan">0</b></div>
    <div class="box"><h4>üìâ Bulan Lalu</h4><b id="sumLalu">0</b></div>
  </div>
</div>

<!-- CHART PRODUKTIVITAS -->
<div class="card">
  <div class="section-title">üìä GRAFIK PRODUKTIVITAS 7 HARI</div>
  <canvas id="chartPanen" style="max-height:280px"></canvas>
</div>

<!-- TOP PEMANEN -->
<div class="card">
  <div class="section-title">üèÜ TOP 5 PEMANEN HARI INI</div>
  <table>
    <thead><tr><th>RANK</th><th>NAMA</th><th>JANJANG</th><th>BLOK</th></tr></thead>
    <tbody id="tabelTop"></tbody>
  </table>
</div>

<!-- ABSENSI -->
<div class="card">
  <div class="section-title">ABSENSI ANGGOTA</div>
  <table>
    <thead><tr><th>NAMA</th><th>STATUS</th></tr></thead>
    <tbody id="tabelAbsensi"></tbody>
  </table>
</div>

<!-- PEMANEN -->
<div class="card">
  <div class="section-title">PEMANEN</div>
  <table>
    <thead><tr><th>NAMA</th><th>BLOK</th><th>JANJANG</th><th>STATUS</th></tr></thead>
    <tbody id="tabelPemanen"></tbody>
    <tfoot>
      <tr>
        <td colspan="2">TOTAL</td>
        <td id="totalJanjang" class="total-number">0</td>
        <td></td>
      </tr>
    </tfoot>
  </table>
</div>

<!-- BRONDOL -->
<div class="card">
  <div class="section-title">KARUNG BRONDOL</div>
  <table>
    <thead><tr><th>NAMA</th><th>JUMLAH</th><th>KETERANGAN</th></tr></thead>
    <tbody id="tabelBrondol"></tbody>
    <tfoot>
      <tr>
        <td>TOTAL</td>
        <td id="totalKarung" class="total-number">0</td>
        <td></td>
      </tr>
    </tfoot>
  </table>
</div>

<!-- KERJA -->
<div class="card">
  <div class="section-title">SEMPROT & TEBAS</div>
  <table>
    <thead><tr><th>JENIS</th><th>BLOK</th><th>ANGGOTA</th><th>STATUS</th></tr></thead>
    <tbody id="tabelKerja"></tbody>
  </table>
</div>

<!-- PROGRESS & EXPORT -->
<div class="card">
  <div class="section-title">üìà PROGRES PANEN HARIAN</div>

  <div style="margin-bottom:14px">
    <div style="background:#e5e7eb;border-radius:999px;height:14px;overflow:hidden">
      <div id="progressBar"
        style="height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#16a34a);transition:.4s">
      </div>
    </div>
    <div id="progressText" style="text-align:center;font-weight:700;margin-top:6px">0%</div>
  </div>

  <div style="display:flex;gap:10px;flex-wrap:wrap" class="export-hide">
    <button onclick="exportPNG()" class="badge" style="background:#8b5cf6;color:#fff">üñºÔ∏è Export PNG HD</button>
    <button onclick="exportPDF()" class="badge selesai">üì• Export PDF</button>
    <button onclick="exportExcel()" class="badge hadir">üìä Export Excel</button>
  </div>
</div>

<!-- EXPORT AREA END -->

</div>

<!-- LOADING -->
<div class="overlay" id="overlay"></div>
<div class="loading" id="loading"><div class="spinner"></div></div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<footer>¬© 2026 Copyright Irwan</footer>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCazwLdErOX7aYw3qh8VSyOsdV5i13S3nQ",
  authDomain:"tools-mandor-sawit.firebaseapp.com",
  projectId:"tools-mandor-sawit"
});
const db=firebase.firestore();
const today=()=>new Date().toISOString().slice(0,10);

/* === UTILITY FUNCTIONS === */
let chartInstance=null;
let allData={pemanen:[],absensi:[],brondol:[],kerja:[]};

function updateDateDisplay(dateStr){
  const d=new Date(dateStr+'T00:00:00');
  const hari=['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'][d.getDay()];
  const bulan=['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'][d.getMonth()];
  const tgl=d.getDate();
  const tahun=d.getFullYear();
  dateDisplay.innerText=`üìÖ ${hari}, ${tgl} ${bulan} ${tahun}`;
}

function showLoading(){loading.style.display='block';overlay.style.display='block'}
function hideLoading(){loading.style.display='none';overlay.style.display='none'}
function showToast(msg,duration=2000){
  toast.innerText=msg;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'),duration);
}

/* === DATA LOADING === */

async function loadRingkasan(){
  const snap=await db.collection("pemanen").get();
  allData.pemanen=[];
  const now=new Date();
  let h=0,s7=0,bln=0,lalu=0;
  snap.forEach(d=>{
    const v={...d.data(),id:d.id};
    allData.pemanen.push(v);
    if(v.jenis!=="Janjang")return;
    const t=new Date(v.tanggal);
    const diff=(now-t)/86400000;
    if(diff<1)h+=v.jumlah;
    if(diff<7)s7+=v.jumlah;
    if(t.getMonth()===now.getMonth()&&t.getFullYear()===now.getFullYear())bln+=v.jumlah;
    const lm=new Date(now.getFullYear(),now.getMonth()-1,1);
    if(t.getMonth()===lm.getMonth()&&t.getFullYear()===lm.getFullYear())lalu+=v.jumlah;
  });
  sumHari.innerText=h+" Tandan";
  sum7.innerText=s7+" Tandan";
  sumBulan.innerText=bln+" Tandan";
  sumLalu.innerText=lalu+" Tandan";
}

async function loadAbsensi(t){
  tabelAbsensi.innerHTML="";
  if(!allData.absensi.length){const snap=await db.collection("absensi").get();allData.absensi=snap.docs.map(d=>({...d.data(),id:d.id}))}
  let count=0;
  allData.absensi.forEach(v=>{
    if(v.tanggal!==t)return;
    count++;
    tabelAbsensi.innerHTML+=`
      <tr><td>${v.nama}</td>
      <td><span class="badge ${v.status==="Hadir"?"hadir":"tidak"}">${v.status}</span></td></tr>`;
  });
  if(!count)tabelAbsensi.innerHTML='<tr><td colspan="2" class="empty">Tidak ada data absensi</td></tr>';
}

async function loadPemanen(t){
  tabelPemanen.innerHTML="";
  let total=0,count=0;
  const search=searchInput.value.toLowerCase();
  allData.pemanen.forEach(v=>{
    if(v.tanggal!==t||v.jenis!=="Janjang")return;
    if(search&&!v.nama.toLowerCase().includes(search)&&!v.blok.toLowerCase().includes(search))return;
    count++;
    total+=v.jumlah;
    const status=v.status||"Belum";
    tabelPemanen.innerHTML+=`
      <tr><td>${v.nama}</td><td>${v.blok}</td><td>${v.jumlah}</td>
      <td><span class="badge ${status==="Selesai"?"selesai":"belum"}">${status}</span></td></tr>`;
  });
  if(!count)tabelPemanen.innerHTML='<tr><td colspan="4" class="empty">Tidak ada data pemanen</td></tr>';
  totalJanjang.innerText=total;
}

async function loadBrondol(t){
  tabelBrondol.innerHTML="";
  let total=0,count=0;
  const search=searchInput.value.toLowerCase();
  allData.pemanen.forEach(v=>{
    if(v.tanggal!==t||v.jenis!=="Brondol")return;
    if(search&&!v.nama.toLowerCase().includes(search))return;
    count++;
    total+=v.jumlah;
    tabelBrondol.innerHTML+=`
      <tr><td>${v.nama}</td><td>${v.jumlah}</td><td>${v.keterangan||""}</td></tr>`;
  });
  if(!count)tabelBrondol.innerHTML='<tr><td colspan="3" class="empty">Tidak ada data brondol</td></tr>';
  totalKarung.innerText=total;
}

async function loadKerja(t){
  tabelKerja.innerHTML="";
  if(!allData.kerja.length){const snap=await db.collection("kerja").get();allData.kerja=snap.docs.map(d=>({...d.data(),id:d.id}))}
  let count=0;
  const search=searchInput.value.toLowerCase();
  allData.kerja.forEach(v=>{
    if(v.tanggal!==t)return;
    if(search&&!v.anggota.toLowerCase().includes(search)&&!v.blok.toLowerCase().includes(search))return;
    count++;
    tabelKerja.innerHTML+=`
      <tr><td>${v.jenis}</td><td>${v.blok}</td><td>${v.anggota}</td>
      <td><span class="badge selesai">Selesai</span></td></tr>`;
  });
  if(!count)tabelKerja.innerHTML='<tr><td colspan="4" class="empty">Tidak ada data kerja</td></tr>';
}

/* === FITUR TAMBAHAN === */

function loadTopPemanen(t){
  tabelTop.innerHTML="";
  const top=allData.pemanen.filter(v=>v.tanggal===t&&v.jenis==="Janjang")
    .sort((a,b)=>b.jumlah-a.jumlah).slice(0,5);
  if(!top.length){tabelTop.innerHTML='<tr><td colspan="4" class="empty">Belum ada data</td></tr>';return}
  top.forEach((v,i)=>{
    const medal=['ü•á','ü•à','ü•â','4Ô∏è‚É£','5Ô∏è‚É£'][i];
    tabelTop.innerHTML+=`<tr><td>${medal}</td><td>${v.nama}</td><td><b>${v.jumlah}</b></td><td>${v.blok}</td></tr>`;
  });
}

function loadChart(){
  const now=new Date();
  const labels=[],data=[];
  for(let i=6;i>=0;i--){
    const d=new Date(now);d.setDate(d.getDate()-i);
    const tgl=d.toISOString().slice(0,10);
    const day=d.toLocaleDateString('id',{weekday:'short'});
    labels.push(day);
    const total=allData.pemanen.filter(v=>v.tanggal===tgl&&v.jenis==="Janjang")
      .reduce((sum,v)=>sum+v.jumlah,0);
    data.push(total);
  }
  if(chartInstance)chartInstance.destroy();
  chartInstance=new Chart(chartPanen,{
    type:'line',
    data:{
      labels,
      datasets:[{label:'Janjang',data,borderColor:'#16a34a',backgroundColor:'rgba(22,163,74,.1)',tension:.3,fill:true}]
    },
    options:{responsive:true,plugins:{legend:{display:true}},scales:{y:{beginAtZero:true}}}
  });
}

async function loadProgress(t){
  let selesai=0,total=0;
  (await db.collection("pemanen").get()).forEach(d=>{
    const v=d.data();
    if(v.tanggal!==t||v.jenis!=="Janjang")return;
    total++;
    if(v.status==="Selesai")selesai++;
  });
  const persen=total?Math.round((selesai/total)*100):0;
  progressBar.style.width=persen+"%";
  progressText.innerText=persen+"% Selesai";
}

function exportPNG(){
  showLoading();
  const exportArea=document.getElementById('exportArea');
  const originalScroll=window.scrollY;
  
  // Tambah class untuk hide export buttons
  document.body.classList.add('exporting');
  exportArea.classList.add('export-mode');
  
  // Scroll ke area export
  exportArea.scrollIntoView({behavior:'instant',block:'start'});
  
  setTimeout(()=>{
    html2canvas(exportArea,{
      scale:3,
      useCORS:true,
      allowTaint:true,
      backgroundColor:'#ffffff',
      logging:false,
      width:exportArea.offsetWidth,
      height:exportArea.scrollHeight,
      windowWidth:exportArea.offsetWidth+100,
      windowHeight:exportArea.scrollHeight+100,
      x:0,
      y:0
    }).then(canvas=>{
      // Restore state
      document.body.classList.remove('exporting');
      exportArea.classList.remove('export-mode');
      window.scrollTo(0,originalScroll);
      hideLoading();
      
      // Download
      const link=document.createElement('a');
      const date=new Date().toISOString().slice(0,10);
      link.download=`Laporan_Sawit_${date}_HD.png`;
      link.href=canvas.toDataURL('image/png',1.0);
      link.click();
      
      showToast('‚úÖ PNG HD berhasil diunduh!');
    }).catch(e=>{
      document.body.classList.remove('exporting');
      exportArea.classList.remove('export-mode');
      window.scrollTo(0,originalScroll);
      hideLoading();
      showToast('‚ùå Gagal export PNG: '+e.message,3000);
    });
  },500);
}

function exportPDF(){
  html2canvas(document.body).then(canvas=>{
    const pdf=new jspdf.jsPDF("p","mm","a4");
    const img=canvas.toDataURL("image/png");
    const w=210,h=canvas.height*w/canvas.width;
    pdf.addImage(img,"PNG",0,0,w,h);
    pdf.save("laporan_sawit.pdf");
  });
}

function exportExcel(){
  const wb=XLSX.utils.book_new();
  document.querySelectorAll("table").forEach((t,i)=>{
    XLSX.utils.book_append_sheet(wb,XLSX.utils.table_to_sheet(t),"Sheet"+(i+1));
  });
  XLSX.writeFile(wb,"laporan_sawit.xlsx");
}

/* LOAD */
async function loadAll(){
  showLoading();
  try{
    const t=tanggal.value;
    updateDateDisplay(t);
    await loadRingkasan();
    await loadAbsensi(t);
    loadPemanen(t);
    loadBrondol(t);
    await loadKerja(t);
    loadProgress(t);
    loadTopPemanen(t);
    loadChart();
    showToast('‚úÖ Data berhasil dimuat!');
  }catch(e){
    showToast('‚ùå Gagal memuat data: '+e.message,3000);
    console.error(e);
  }finally{
    hideLoading();
  }
}

tanggal.value=today();
updateDateDisplay(today());
tanggal.addEventListener("change",loadAll);
searchInput.addEventListener("input",()=>{
  const t=tanggal.value;
  loadPemanen(t);
  loadBrondol(t);
  loadKerja(t);
});
loadAll();
</script>

</body>
</html>
