<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Laporan Sawit</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
/* === CSS SAMA DENGAN VERSI TERAKHIR + TAMBAHAN === */
*{box-sizing:border-box}
body{font-family:'Segoe UI',Arial,sans-serif;background:#f1f5f9;margin:0;color:#1f2937}
h2{text-align:center;margin:20px 0 4px;font-weight:700}
.subtitle{text-align:center;color:#6b7280;margin-bottom:14px}
.container{max-width:1100px;margin:auto;padding:14px}
.card{background:#fff;padding:18px;border-radius:18px;margin-bottom:18px;box-shadow:0 10px 25px rgba(0,0,0,.07)}
.section-title{font-weight:700;margin-bottom:10px;color:#14532d}

button{
  padding:8px 14px;
  border:none;
  border-radius:10px;
  background:#14532d;
  color:#fff;
  font-weight:600;
  cursor:pointer
}
button.secondary{background:#334155}

.progress-box{
  background:#f0fdf4;
  border-radius:14px;
  padding:14px
}
.progress-bar{
  height:14px;
  border-radius:999px;
  background:#e5e7eb;
  overflow:hidden;
  margin-top:6px
}
.progress-bar span{
  display:block;
  height:100%;
  background:linear-gradient(90deg,#22c55e,#16a34a);
  width:0%
}
.progress-text{font-weight:700;margin-top:6px;text-align:center}

canvas{max-width:100%}

@media(max-width:700px){
  canvas{height:260px!important}
}
</style>
</head>

<body>
<h2>ðŸ“Š Dashboard Laporan Sawit</h2>
<div class="subtitle">Monitoring Panen & Progres</div>

<div class="container" id="areaExport">

<!-- BUTTON EXPORT -->
<div class="card" style="display:flex;gap:10px;flex-wrap:wrap">
  <button onclick="exportPDF()">ðŸ“¥ Export PDF</button>
  <button class="secondary" onclick="exportExcel()">ðŸ“Š Export Excel</button>
</div>

<!-- PROGRES PANEN -->
<div class="card">
  <div class="section-title">ðŸ“ˆ Progres Panen Hari Ini</div>
  <div class="progress-box">
    <div class="progress-bar"><span id="progressFill"></span></div>
    <div class="progress-text" id="progressText">0%</div>
  </div>
</div>

<!-- GRAFIK -->
<div class="card">
  <div class="section-title">ðŸ“Š Grafik Panen Harian (7 Hari)</div>
  <canvas id="chartHarian"></canvas>
</div>

<div class="card">
  <div class="section-title">ðŸ“Š Grafik Panen Bulanan</div>
  <canvas id="chartBulanan"></canvas>
</div>

</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyCazwLdErOX7aYw3qh8VSyOsdV5i13S3nQ",
  authDomain:"tools-mandor-sawit.firebaseapp.com",
  projectId:"tools-mandor-sawit"
});
const db=firebase.firestore();

/* === PROGRES PANEN === */
async function loadProgress(){
  const snap=await db.collection("pemanen").get();
  let selesai=0,total=0;
  const today=new Date().toISOString().slice(0,10);

  snap.forEach(d=>{
    const v=d.data();
    if(v.tanggal!==today||v.jenis!=="Janjang")return;
    total+=v.jumlah;
    if(v.status==="Selesai")selesai+=v.jumlah;
  });

  const persen=total?Math.round((selesai/total)*100):0;
  progressFill.style.width=persen+"%";
  progressText.innerText=persen+"% ("+selesai+"/"+total+" Tandan)";
}

/* === GRAFIK HARIAN === */
async function loadChartHarian(){
  const snap=await db.collection("pemanen").get();
  const labels=[],data=[];
  for(let i=6;i>=0;i--){
    const d=new Date();d.setDate(d.getDate()-i);
    const t=d.toISOString().slice(0,10);
    labels.push(t.slice(5));
    let sum=0;
    snap.forEach(x=>{
      const v=x.data();
      if(v.tanggal===t&&v.jenis==="Janjang")sum+=v.jumlah;
    });
    data.push(sum);
  }
  new Chart(chartHarian,{
    type:"bar",
    data:{labels,datasets:[{label:"Tandan",data}]}
  });
}

/* === GRAFIK BULANAN === */
async function loadChartBulanan(){
  const snap=await db.collection("pemanen").get();
  const labels=["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
  const data=new Array(12).fill(0);
  const y=new Date().getFullYear();

  snap.forEach(d=>{
    const v=d.data();
    if(v.jenis!=="Janjang")return;
    const t=new Date(v.tanggal);
    if(t.getFullYear()===y)data[t.getMonth()]+=v.jumlah;
  });

  new Chart(chartBulanan,{
    type:"line",
    data:{labels,datasets:[{label:"Tandan",data,fill:true}]}
  });
}

/* === EXPORT PDF === */
async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF("p","mm","a4");
  const canvas=await html2canvas(areaExport,{scale:2});
  const img=canvas.toDataURL("image/png");
  pdf.addImage(img,"PNG",10,10,190,0);
  pdf.save("laporan-sawit.pdf");
}

/* === EXPORT EXCEL === */
function exportExcel(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.json_to_sheet([{Info:"Export dari Dashboard Sawit"}]);
  XLSX.utils.book_append_sheet(wb,ws,"Laporan");
  XLSX.writeFile(wb,"laporan-sawit.xlsx");
}

/* INIT */
loadProgress();
loadChartHarian();
loadChartBulanan();
</script>

</body>
</html>
