<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Laporan Sawit</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-slate-100 text-slate-800">

<header class="text-center py-6">
  <h1 class="text-2xl font-bold">ðŸ“Š Dashboard Laporan Sawit</h1>
  <p class="text-slate-500 text-sm">Rekap & Monitoring Panen</p>
</header>

<div class="max-w-6xl mx-auto px-4 pb-10" id="areaExport">

<!-- FILTER -->
<div class="bg-white rounded-2xl shadow p-4 mb-6 flex justify-center gap-3">
  <span class="font-semibold">Tanggal</span>
  <input type="date" id="tanggal"
    class="border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500">
</div>

<!-- RINGKASAN -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
  <div class="bg-green-50 rounded-2xl p-4 text-center">
    <p class="text-sm text-green-700">ðŸŒ´ Hari Ini</p>
    <b id="sumHari" class="text-2xl">0</b>
  </div>
  <div class="bg-blue-50 rounded-2xl p-4 text-center">
    <p class="text-sm text-blue-700">ðŸ“Š 7 Hari</p>
    <b id="sum7" class="text-2xl">0</b>
  </div>
  <div class="bg-emerald-50 rounded-2xl p-4 text-center">
    <p class="text-sm text-emerald-700">ðŸ“ˆ Bulan Ini</p>
    <b id="sumBulan" class="text-2xl">0</b>
  </div>
  <div class="bg-rose-50 rounded-2xl p-4 text-center">
    <p class="text-sm text-rose-700">ðŸ“‰ Bulan Lalu</p>
    <b id="sumLalu" class="text-2xl">0</b>
  </div>
</div>

<!-- ABSENSI -->
<div class="bg-white rounded-2xl shadow p-4 mb-6">
  <h2 class="font-bold mb-3">ABSENSI</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-100">
        <tr><th class="p-3 text-left">Nama</th><th class="p-3 text-center">Status</th></tr>
      </thead>
      <tbody id="tabelAbsensi" class="divide-y"></tbody>
    </table>
  </div>
</div>

<!-- PEMANEN -->
<div class="bg-white rounded-2xl shadow p-4 mb-6">
  <h2 class="font-bold mb-3">PEMANEN</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-100">
        <tr>
          <th class="p-3 text-left">Nama</th>
          <th class="p-3 text-center">Blok</th>
          <th class="p-3 text-center">Janjang</th>
          <th class="p-3 text-center">Status</th>
        </tr>
      </thead>
      <tbody id="tabelPemanen" class="divide-y"></tbody>
      <tfoot>
        <tr class="bg-green-50 font-bold">
          <td colspan="2" class="p-3 text-right">TOTAL</td>
          <td id="totalJanjang" class="p-3 text-center text-lg">0</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- BRONDOL -->
<div class="bg-white rounded-2xl shadow p-4 mb-6">
  <h2 class="font-bold mb-3">KARUNG BRONDOL</h2>
  <table class="min-w-full text-sm">
    <thead class="bg-slate-100">
      <tr><th class="p-3 text-left">Nama</th><th class="p-3 text-center">Jumlah</th><th class="p-3">Keterangan</th></tr>
    </thead>
    <tbody id="tabelBrondol" class="divide-y"></tbody>
    <tfoot>
      <tr class="bg-green-50 font-bold">
        <td class="p-3 text-right">TOTAL</td>
        <td id="totalKarung" class="p-3 text-center text-lg">0</td>
        <td></td>
      </tr>
    </tfoot>
  </table>
</div>

<!-- KERJA -->
<div class="bg-white rounded-2xl shadow p-4 mb-6">
  <h2 class="font-bold mb-3">SEMPROT & TEBAS</h2>
  <table class="min-w-full text-sm">
    <thead class="bg-slate-100">
      <tr><th class="p-3">Jenis</th><th class="p-3">Blok</th><th class="p-3">Anggota</th><th class="p-3">Status</th></tr>
    </thead>
    <tbody id="tabelKerja" class="divide-y"></tbody>
  </table>
</div>

<!-- EXPORT + PROGRESS -->
<div class="grid md:grid-cols-2 gap-4">
  <div class="bg-white rounded-2xl shadow p-4 flex gap-3">
    <button onclick="exportPDF()" class="bg-green-600 text-white px-4 py-2 rounded-xl">ðŸ“¥ PDF</button>
    <button onclick="exportExcel()" class="bg-slate-700 text-white px-4 py-2 rounded-xl">ðŸ“Š Excel</button>
  </div>

  <div class="bg-white rounded-2xl shadow p-4">
    <h2 class="font-bold mb-2">ðŸ“ˆ Progres Panen Hari Ini</h2>
    <div class="w-full bg-slate-200 rounded-full h-4 overflow-hidden">
      <div id="progressFill" class="bg-green-500 h-full"></div>
    </div>
    <p id="progressText" class="text-center font-bold mt-2">0%</p>
  </div>
</div>

</div>

<footer class="text-center text-xs text-slate-500 py-6">
Â© 2026 Dashboard Mandor Sawit
</footer>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCazwLdErOX7aYw3qh8VSyOsdV5i13S3nQ",
  authDomain:"tools-mandor-sawit.firebaseapp.com",
  projectId:"tools-mandor-sawit"
});
const db=firebase.firestore();
const today=()=>new Date().toISOString().slice(0,10);

function badge(txt){
  const map={
    Hadir:"bg-blue-100 text-blue-700",
    Tidak:"bg-red-100 text-red-700",
    Selesai:"bg-green-100 text-green-700",
    Belum:"bg-red-100 text-red-700"
  };
  return `<span class="px-3 py-1 rounded-full text-xs font-bold ${map[txt]||""}">${txt}</span>`;
}

async function loadRingkasan(){
  const snap=await db.collection("pemanen").get();
  const now=new Date();
  let h=0,s7=0,b=0,l=0;
  snap.forEach(d=>{
    const v=d.data();
    if(v.jenis!=="Janjang")return;
    const t=new Date(v.tanggal);
    const diff=(now-t)/86400000;
    if(diff<1)h+=v.jumlah;
    if(diff<7)s7+=v.jumlah;
    if(t.getMonth()===now.getMonth())b+=v.jumlah;
    const lm=new Date(now.getFullYear(),now.getMonth()-1,1);
    if(t.getMonth()===lm.getMonth())l+=v.jumlah;
  });
  sumHari.innerText=h;
  sum7.innerText=s7;
  sumBulan.innerText=b;
  sumLalu.innerText=l;
}

async function loadAbsensi(t){
  tabelAbsensi.innerHTML="";
  (await db.collection("absensi").get()).forEach(d=>{
    const v=d.data();
    if(v.tanggal!==t)return;
    tabelAbsensi.innerHTML+=`<tr><td class="p-3">${v.nama}</td><td class="p-3 text-center">${badge(v.status)}</td></tr>`;
  });
}

async function loadPemanen(t){
  tabelPemanen.innerHTML="";let total=0;
  (await db.collection("pemanen").get()).forEach(d=>{
    const v=d.data();
    if(v.tanggal!==t||v.jenis!=="Janjang")return;
    total+=v.jumlah;
    tabelPemanen.innerHTML+=
      `<tr>
        <td class="p-3">${v.nama}</td>
        <td class="p-3 text-center">${v.blok}</td>
        <td class="p-3 text-center">${v.jumlah}</td>
        <td class="p-3 text-center">${badge(v.status||"Belum")}</td>
      </tr>`;
  });
  totalJanjang.innerText=total;
}

async function loadBrondol(t){
  tabelBrondol.innerHTML="";let total=0;
  (await db.collection("pemanen").get()).forEach(d=>{
    const v=d.data();
    if(v.tanggal!==t||v.jenis!=="Brondol")return;
    total+=v.jumlah;
    tabelBrondol.innerHTML+=
      `<tr><td class="p-3">${v.nama}</td><td class="p-3 text-center">${v.jumlah}</td><td class="p-3">${v.keterangan||""}</td></tr>`;
  });
  totalKarung.innerText=total;
}

async function loadKerja(t){
  tabelKerja.innerHTML="";
  (await db.collection("kerja").get()).forEach(d=>{
    const v=d.data();
    if(v.tanggal!==t)return;
    tabelKerja.innerHTML+=
      `<tr><td class="p-3">${v.jenis}</td><td class="p-3">${v.blok}</td><td class="p-3">${v.anggota}</td><td class="p-3 text-center">${badge("Selesai")}</td></tr>`;
  });
}

async function loadProgress(){
  const snap=await db.collection("pemanen").get();
  let s=0,t=0;
  snap.forEach(d=>{
    const v=d.data();
    if(v.tanggal!==today()||v.jenis!=="Janjang")return;
    t+=v.jumlah;
    if(v.status==="Selesai")s+=v.jumlah;
  });
  const p=t?Math.round((s/t)*100):0;
  progressFill.style.width=p+"%";
  progressText.innerText=p+"% ("+s+"/"+t+" Tandan)";
}

function loadAll(){
  const t=tanggal.value;
  loadRingkasan();
  loadAbsensi(t);
  loadPemanen(t);
  loadBrondol(t);
  loadKerja(t);
  loadProgress();
}

tanggal.value=today();
tanggal.addEventListener("change",loadAll);
loadAll();

/* EXPORT */
async function exportPDF(){
  const { jsPDF }=window.jspdf;
  const pdf=new jsPDF("p","mm","a4");
  const canvas=await html2canvas(areaExport,{scale:2});
  pdf.addImage(canvas.toDataURL("image/png"),"PNG",10,10,190,0);
  pdf.save("laporan-sawit.pdf");
}
function exportExcel(){
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet([{Info:"Dashboard Sawit"}]),"Laporan");
  XLSX.writeFile(wb,"laporan-sawit.xlsx");
}
</script>

</body>
</html>
